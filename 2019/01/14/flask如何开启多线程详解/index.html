<!DOCTYPE html>












  


<html class="theme-next gemini use-motion" lang="zh-CN">
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">


























<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2">

<link rel="stylesheet" href="/css/main.css?v=6.7.0">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=6.7.0">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=6.7.0">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=6.7.0">


  <link rel="mask-icon" href="/images/logo.svg?v=6.7.0" color="#222">







<script id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Gemini',
    version: '6.7.0',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: false,
    fastclick: false,
    lazyload: false,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>


  




  <meta name="description" content="flask开启多线程 在我之前写的’flask中current_app、g、request、session源码的深究和理解’一文中解释了flask如何支持多线程主要通过两个类来实现,LocalStack和Local,在Local中有两个属性,__storage__和__ident_func__,后者用来获取线程id,从而区分不同线程发来的请求  这次要说的是flask如何开启多线程 先从app.">
<meta name="keywords" content="flask,python">
<meta property="og:type" content="article">
<meta property="og:title" content="flask如何开启多线程详解">
<meta property="og:url" content="http://yoursite.com/2019/01/14/flask如何开启多线程详解/index.html">
<meta property="og:site_name" content="Easythink">
<meta property="og:description" content="flask开启多线程 在我之前写的’flask中current_app、g、request、session源码的深究和理解’一文中解释了flask如何支持多线程主要通过两个类来实现,LocalStack和Local,在Local中有两个属性,__storage__和__ident_func__,后者用来获取线程id,从而区分不同线程发来的请求  这次要说的是flask如何开启多线程 先从app.">
<meta property="og:locale" content="zh-CN">
<meta property="og:updated_time" content="2019-01-16T04:33:53.213Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="flask如何开启多线程详解">
<meta name="twitter:description" content="flask开启多线程 在我之前写的’flask中current_app、g、request、session源码的深究和理解’一文中解释了flask如何支持多线程主要通过两个类来实现,LocalStack和Local,在Local中有两个属性,__storage__和__ident_func__,后者用来获取线程id,从而区分不同线程发来的请求  这次要说的是flask如何开启多线程 先从app.">






  <link rel="canonical" href="http://yoursite.com/2019/01/14/flask如何开启多线程详解/">



<script id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>

  <title>flask如何开启多线程详解 | Easythink</title>
  












  <noscript>
  <style>
  .use-motion .motion-element,
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-title { opacity: initial; }

  .use-motion .logo,
  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope="" itemtype="http://schema.org/WebPage" lang="zh-CN">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope="" itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Easythink</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
    
    
  </div>

  <div class="site-nav-toggle">
    <button aria-label="切换导航栏">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>



<nav class="site-nav">
  
    <ul id="menu" class="menu">
      
        
        
        
          
          <li class="menu-item menu-item-home">

    
    
    
      
    

    

    <a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i> <br>首页</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-about">

    
    
    
      
    

    

    <a href="/about/" rel="section"><i class="menu-item-icon fa fa-fw fa-user"></i> <br>关于</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-tags">

    
    
    
      
    

    

    <a href="/tags/" rel="section"><i class="menu-item-icon fa fa-fw fa-tags"></i> <br>标签</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-categories">

    
    
    
      
    

    

    <a href="/categories/" rel="section"><i class="menu-item-icon fa fa-fw fa-th"></i> <br>分类</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-archives">

    
    
    
      
    

    

    <a href="/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i> <br>归档</a>

  </li>

      
      
    </ul>
  

  

  
</nav>



  



</div>
    </header>

    


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          
            

          
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/01/14/flask如何开启多线程详解/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="顾金鑫">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Easythink">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">flask如何开启多线程详解

              
            
          </h1>
        

        <div class="post-meta">
          
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2019-01-14 10:11:25" itemprop="dateCreated datePublished" datetime="2019-01-14T10:11:25+08:00">2019-01-14</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2019-01-16 12:33:53" itemprop="dateModified" datetime="2019-01-16T12:33:53+08:00">2019-01-16</time>
              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing"><a href="/categories/python/" itemprop="url" rel="index"><span itemprop="name">python</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          
            <span class="post-meta-divider">|</span>
            <span class="post-meta-item-icon">
            <i class="fa fa-eye"></i>
             阅读次数： 
            <span class="busuanzi-value" id="busuanzi_value_page_pv"></span>
            </span>
          

          
            <div class="post-symbolscount">
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">本文字数：</span>
                
                <span title="本文字数">14k</span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">12 分钟</span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <blockquote>
<h1 id="flask开启多线程"><a href="#flask开启多线程" class="headerlink" title="flask开启多线程"></a>flask开启多线程</h1><hr>
<p>在我之前写的’flask中current_app、g、request、session源码的深究和理解’一文中解释了flask如何支持多线程<br>主要通过两个类来实现,LocalStack和Local,在Local中有两个属性,__storage__和__ident_func__,后者用来获取线程id,从而区分不同线程发来的请求</p>
<hr>
<p>这次要说的是flask如何开启多线程</p>
<p>先从app.run()这个方法看起</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br></pre></td><td class="code"><pre><span class="line">         def run(self, host=None, port=None, debug=None, **options):</span><br><span class="line">             from werkzeug.serving import run_simple</span><br><span class="line">             if host is None:</span><br><span class="line">                 host = &apos;127.0.0.1&apos;</span><br><span class="line">             if port is None:</span><br><span class="line">                 server_name = self.config[&apos;SERVER_NAME&apos;]</span><br><span class="line">                 if server_name and &apos;:&apos; in server_name:</span><br><span class="line">                     port = int(server_name.rsplit(&apos;:&apos;, 1)[1])</span><br><span class="line">                 else:</span><br><span class="line">                     port = 5000</span><br><span class="line">             if debug is not None:</span><br><span class="line">                 self.debug = bool(debug)</span><br><span class="line">             options.setdefault(&apos;use_reloader&apos;, self.debug)</span><br><span class="line">             options.setdefault(&apos;use_debugger&apos;, self.debug)</span><br><span class="line">             try:</span><br><span class="line">                 run_simple(host, port, self, **options)  #会进入这个函数</span><br><span class="line">             finally:</span><br><span class="line">                 # reset the first request information if the development server</span><br><span class="line">                 # reset normally.  This makes it possible to restart the server</span><br><span class="line">                 # without reloader and that stuff from an interactive shell.</span><br><span class="line">                 self._got_first_request = False</span><br><span class="line">``` </span><br><span class="line">&gt; </span><br><span class="line">&gt; 经过判断和设置后进入run_simple()这个函数,看下源码</span><br><span class="line">&gt; </span><br><span class="line">```  </span><br><span class="line">     def run_simple(hostname, port, application, use_reloader=False,</span><br><span class="line">                    use_debugger=False, use_evalex=True,</span><br><span class="line">                    extra_files=None, reloader_interval=1,</span><br><span class="line">                    reloader_type=&apos;auto&apos;, threaded=False,</span><br><span class="line">                    processes=1, request_handler=None, static_files=None,</span><br><span class="line">                    passthrough_errors=False, ssl_context=None):</span><br><span class="line">         &quot;&quot;&quot;Start a WSGI application. Optional features include a reloader,</span><br><span class="line">         multithreading and fork support.</span><br><span class="line">     </span><br><span class="line">         This function has a command-line interface too::</span><br><span class="line">     </span><br><span class="line">             python -m werkzeug.serving --help</span><br><span class="line">     </span><br><span class="line">         .. versionadded:: 0.5</span><br><span class="line">            `static_files` was added to simplify serving of static files as well</span><br><span class="line">            as `passthrough_errors`.</span><br><span class="line">     </span><br><span class="line">         .. versionadded:: 0.6</span><br><span class="line">            support for SSL was added.</span><br><span class="line">     </span><br><span class="line">         .. versionadded:: 0.8</span><br><span class="line">            Added support for automatically loading a SSL context from certificate</span><br><span class="line">            file and private key.</span><br><span class="line">     </span><br><span class="line">         .. versionadded:: 0.9</span><br><span class="line">            Added command-line interface.</span><br><span class="line">     </span><br><span class="line">         .. versionadded:: 0.10</span><br><span class="line">            Improved the reloader and added support for changing the backend</span><br><span class="line">            through the `reloader_type` parameter.  See :ref:`reloader`</span><br><span class="line">            for more information.</span><br><span class="line">     </span><br><span class="line">         :param hostname: The host for the application.  eg: ``&apos;localhost&apos;``</span><br><span class="line">         :param port: The port for the server.  eg: ``8080``</span><br><span class="line">         :param application: the WSGI application to execute</span><br><span class="line">         :param use_reloader: should the server automatically restart the python</span><br><span class="line">                              process if modules were changed?</span><br><span class="line">         :param use_debugger: should the werkzeug debugging system be used?</span><br><span class="line">         :param use_evalex: should the exception evaluation feature be enabled?</span><br><span class="line">         :param extra_files: a list of files the reloader should watch</span><br><span class="line">                             additionally to the modules.  For example configuration</span><br><span class="line">                             files.</span><br><span class="line">         :param reloader_interval: the interval for the reloader in seconds.</span><br><span class="line">         :param reloader_type: the type of reloader to use.  The default is</span><br><span class="line">                               auto detection.  Valid values are ``&apos;stat&apos;`` and</span><br><span class="line">                               ``&apos;watchdog&apos;``. See :ref:`reloader` for more</span><br><span class="line">                               information.</span><br><span class="line">         :param threaded: should the process handle each request in a separate</span><br><span class="line">                          thread?</span><br><span class="line">         :param processes: if greater than 1 then handle each request in a new process</span><br><span class="line">                           up to this maximum number of concurrent processes.</span><br><span class="line">         :param request_handler: optional parameter that can be used to replace</span><br><span class="line">                                 the default one.  You can use this to replace it</span><br><span class="line">                                 with a different</span><br><span class="line">                                 :class:`~BaseHTTPServer.BaseHTTPRequestHandler`</span><br><span class="line">                                 subclass.</span><br><span class="line">         :param static_files: a list or dict of paths for static files.  This works</span><br><span class="line">                              exactly like :class:`SharedDataMiddleware`, it&apos;s actually</span><br><span class="line">                              just wrapping the application in that middleware before</span><br><span class="line">                              serving.</span><br><span class="line">         :param passthrough_errors: set this to `True` to disable the error catching.</span><br><span class="line">                                    This means that the server will die on errors but</span><br><span class="line">                                    it can be useful to hook debuggers in (pdb etc.)</span><br><span class="line">         :param ssl_context: an SSL context for the connection. Either an</span><br><span class="line">                             :class:`ssl.SSLContext`, a tuple in the form</span><br><span class="line">                             ``(cert_file, pkey_file)``, the string ``&apos;adhoc&apos;`` if</span><br><span class="line">                             the server should automatically create one, or ``None``</span><br><span class="line">                             to disable SSL (which is the default).</span><br><span class="line">         &quot;&quot;&quot;</span><br><span class="line">         if not isinstance(port, int):</span><br><span class="line">             raise TypeError(&apos;port must be an integer&apos;)</span><br><span class="line">         if use_debugger:</span><br><span class="line">             from werkzeug.debug import DebuggedApplication</span><br><span class="line">             application = DebuggedApplication(application, use_evalex)</span><br><span class="line">         if static_files:</span><br><span class="line">             from werkzeug.wsgi import SharedDataMiddleware</span><br><span class="line">             application = SharedDataMiddleware(application, static_files)</span><br><span class="line">     </span><br><span class="line">         def log_startup(sock):</span><br><span class="line">             display_hostname = hostname not in (&apos;&apos;, &apos;*&apos;) and hostname or &apos;localhost&apos;</span><br><span class="line">             if &apos;:&apos; in display_hostname:</span><br><span class="line">                 display_hostname = &apos;[%s]&apos; % display_hostname</span><br><span class="line">             quit_msg = &apos;(Press CTRL+C to quit)&apos;</span><br><span class="line">             port = sock.getsockname()[1]</span><br><span class="line">             _log(&apos;info&apos;, &apos; * Running on %s://%s:%d/ %s&apos;,</span><br><span class="line">                  ssl_context is None and &apos;http&apos; or &apos;https&apos;,</span><br><span class="line">                  display_hostname, port, quit_msg)</span><br><span class="line">     </span><br><span class="line">         def inner():</span><br><span class="line">             try:</span><br><span class="line">                 fd = int(os.environ[&apos;WERKZEUG_SERVER_FD&apos;])</span><br><span class="line">             except (LookupError, ValueError):</span><br><span class="line">                 fd = None</span><br><span class="line">             srv = make_server(hostname, port, application, threaded,</span><br><span class="line">                               processes, request_handler,</span><br><span class="line">                               passthrough_errors, ssl_context,</span><br><span class="line">                               fd=fd)</span><br><span class="line">             if fd is None:</span><br><span class="line">                 log_startup(srv.socket)</span><br><span class="line">             srv.serve_forever()</span><br><span class="line">     </span><br><span class="line">         if use_reloader:</span><br><span class="line">             # If we&apos;re not running already in the subprocess that is the</span><br><span class="line">             # reloader we want to open up a socket early to make sure the</span><br><span class="line">             # port is actually available.</span><br><span class="line">             if os.environ.get(&apos;WERKZEUG_RUN_MAIN&apos;) != &apos;true&apos;:</span><br><span class="line">                 if port == 0 and not can_open_by_fd:</span><br><span class="line">                     raise ValueError(&apos;Cannot bind to a random port with enabled &apos;</span><br><span class="line">                                      &apos;reloader if the Python interpreter does &apos;</span><br><span class="line">                                      &apos;not support socket opening by fd.&apos;)</span><br><span class="line">     </span><br><span class="line">                 # Create and destroy a socket so that any exceptions are</span><br><span class="line">                 # raised before we spawn a separate Python interpreter and</span><br><span class="line">                 # lose this ability.</span><br><span class="line">                 address_family = select_ip_version(hostname, port)</span><br><span class="line">                 s = socket.socket(address_family, socket.SOCK_STREAM)</span><br><span class="line">                 s.setsockopt(socket.SOL_SOCKET, socket.SO_REUSEADDR, 1)</span><br><span class="line">                 s.bind(get_sockaddr(hostname, port, address_family))</span><br><span class="line">                 if hasattr(s, &apos;set_inheritable&apos;):</span><br><span class="line">                     s.set_inheritable(True)</span><br><span class="line">     </span><br><span class="line">                 # If we can open the socket by file descriptor, then we can just</span><br><span class="line">                 # reuse this one and our socket will survive the restarts.</span><br><span class="line">                 if can_open_by_fd:</span><br><span class="line">                     os.environ[&apos;WERKZEUG_SERVER_FD&apos;] = str(s.fileno())</span><br><span class="line">                     s.listen(LISTEN_QUEUE)</span><br><span class="line">                     log_startup(s)</span><br><span class="line">                 else:</span><br><span class="line">                     s.close()</span><br><span class="line">     </span><br><span class="line">             # Do not use relative imports, otherwise &quot;python -m werkzeug.serving&quot;</span><br><span class="line">             # breaks.</span><br><span class="line">             from werkzeug._reloader import run_with_reloader</span><br><span class="line">             run_with_reloader(inner, extra_files, reloader_interval,</span><br><span class="line">                               reloader_type)</span><br><span class="line">         else:</span><br><span class="line">             inner()  #默认会执行</span><br><span class="line">     </span><br><span class="line"> </span><br><span class="line"> 还是经过一系列判断后默认会进入inner()函数,这个函数定义在run\_simple()内,属于闭包,inner()中会执行make\_server()这个函数,看下源码:</span><br><span class="line"> </span><br><span class="line">     </span><br><span class="line">     def make_server(host=None, port=None, app=None, threaded=False, processes=1,</span><br><span class="line">                     request_handler=None, passthrough_errors=False,</span><br><span class="line">                     ssl_context=None, fd=None):</span><br><span class="line">         &quot;&quot;&quot;Create a new server instance that is either threaded, or forks</span><br><span class="line">         or just processes one request after another.</span><br><span class="line">         &quot;&quot;&quot;</span><br><span class="line">         if threaded and processes &gt; 1:</span><br><span class="line">             raise ValueError(&quot;cannot have a multithreaded and &quot;</span><br><span class="line">                              &quot;multi process server.&quot;)</span><br><span class="line">         elif threaded:</span><br><span class="line">             return ThreadedWSGIServer(host, port, app, request_handler,</span><br><span class="line">                                       passthrough_errors, ssl_context, fd=fd)</span><br><span class="line">         elif processes &gt; 1:</span><br><span class="line">             return ForkingWSGIServer(host, port, app, processes, request_handler,</span><br><span class="line">                                      passthrough_errors, ssl_context, fd=fd)</span><br><span class="line">         else:</span><br><span class="line">             return BaseWSGIServer(host, port, app, request_handler,</span><br><span class="line">                                   passthrough_errors, ssl_context, fd=fd)</span><br><span class="line">     </span><br><span class="line"> </span><br><span class="line"> 看到这也很明白了,想要配置多线程或者多进程,则需要设置threaded或processes这两个参数,而这两个参数是从app.run()中传递过来的:  </span><br><span class="line"> app.run(**options) ---&gt; run\_simple(threaded,processes) ---&gt; make\_server(threaded,processes)  </span><br><span class="line"> 默认情况下flask是单线程,单进程的,想要开启只需要在run中传入对应的参数:app.run(threaded=True)即可.  </span><br><span class="line"> 从make_server中可知,flask提供了三种server:ThreadedWSGIServer,ForkingWSGIServer,BaseWSGIServer,默认情况下是BaseWSGIServer  </span><br><span class="line"> 以线程为例,看下ThreadedWSGIServer这个类:</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">class ThreadedWSGIServer(ThreadingMixIn, BaseWSGIServer):  #继承自ThreadingMixIn, BaseWSGIServer</span><br><span class="line"></span><br><span class="line">    &quot;&quot;&quot;A WSGI server that does threading.&quot;&quot;&quot;</span><br><span class="line">    multithread = True</span><br><span class="line">    daemon_threads = True</span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line">ThreadingMixIn = socketserver.ThreadingMixIn</span><br><span class="line"></span><br><span class="line">class ThreadingMixIn:</span><br><span class="line">    &quot;&quot;&quot;Mix-in class to handle each request in a new thread.&quot;&quot;&quot;</span><br><span class="line">    </span><br><span class="line">    # Decides how threads will act upon termination of the</span><br><span class="line">    # main process</span><br><span class="line">    daemon_threads = False</span><br><span class="line"></span><br><span class="line">    def process_request_thread(self, request, client_address):</span><br><span class="line">        &quot;&quot;&quot;Same as in BaseServer but as a thread.</span><br><span class="line"></span><br><span class="line">        In addition, exception handling is done here.</span><br><span class="line"></span><br><span class="line">        &quot;&quot;&quot;</span><br><span class="line">        try:</span><br><span class="line">            self.finish_request(request, client_address)</span><br><span class="line">            self.shutdown_request(request)</span><br><span class="line">        except:</span><br><span class="line">            self.handle_error(request, client_address)</span><br><span class="line">            self.shutdown_request(request)</span><br><span class="line"></span><br><span class="line">    def process_request(self, request, client_address):</span><br><span class="line">        &quot;&quot;&quot;Start a new thread to process the request.&quot;&quot;&quot;</span><br><span class="line">        t = threading.Thread(target = self.process_request_thread,</span><br><span class="line">                             args = (request, client_address))</span><br><span class="line">        t.daemon = self.daemon_threads</span><br><span class="line">        t.start()</span><br></pre></td></tr></table></figure>
<blockquote>
<p>process_request就是对每个请求产生一个新的线程来处理<br>最后写一个非常简单的应用来验证以上说法:</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">from flask import Flask</span><br><span class="line">from flask import _request_ctx_stack</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">@app.route(&apos;/&apos;)</span><br><span class="line">def index():</span><br><span class="line">    print(_request_ctx_stack._local.__ident_func__())</span><br><span class="line">    while True:</span><br><span class="line">        pass</span><br><span class="line">    return &apos;&lt;h1&gt;hello&lt;/h1&gt;&apos;</span><br><span class="line"></span><br><span class="line">app.run()  #如果需要开启多线程则app.run(threaded=True)</span><br></pre></td></tr></table></figure>
<blockquote>
<p>_request_ctx_stack._local.__ident_func__()对应这get_ident()这个函数,返回当前线程id,为什么要在后面加上while True这句呢,我们看下get_ident()这个函数的说明:  </p>
<hr>
<p>Return a non-zero integer that uniquely identifies the current thread amongst other threads that exist simultaneously. This may be used to identify per-thread resources. Even though on some platforms threads identities may appear to be allocated consecutive numbers starting at 1, this behavior should not be relied upon, and the number should be seen purely as a magic cookie. <strong>A thread’s identity may be reused for another thread after it exits.</strong></p>
<hr>
<p>关键字我已经加粗了,线程id会在线程结束后重复利用,所以我在路由函数中加了这个死循环来阻塞请求以便于观察到不同的id,这就会产生两种情况:<br>1.没开启多线程的情况下,一次请求过来,服务器直接阻塞,并且之后的其他请求也都阻塞<br>2.开启多线程情况下,每次都会打印出不同的线程id  </p>
<pre><code>结果:
---------------------
第一种情况
&gt;&gt;&gt; * Running on http://127.0.0.1:5000/ (Press CTRL+C to quit)
&gt;&gt;&gt;139623180527360
---------------------
第二种情况
&gt;&gt;&gt; * Running on http://127.0.0.1:5000/ (Press CTRL+C to quit)
&gt;&gt;&gt;140315469436672
&gt;&gt;&gt;140315477829376
&gt;&gt;&gt;140315486222080
&gt;&gt;&gt;140315316901632
&gt;&gt;&gt;140315105163008
&gt;&gt;&gt;140315096770304
&gt;&gt;&gt;140315088377600
</code></pre><p>结果显而易见<br>综上所述:flask支持多线程,但默认没开启,其次app.run()只适用于开发环境,生产环境下可以使用uWSGI,Gunicorn等web服务器</p>
</blockquote>

      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/flask/" rel="tag"><i class="fa fa-tag"></i>
 flask</a>
          
            <a href="/tags/python/" rel="tag"><i class="fa fa-tag"></i>
 python</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2019/01/14/flask中current-app、g、request、session源码的深究和理解/" rel="next" title="flask中current_app、g、request、session源码的深究和理解">
                <i class="fa fa-chevron-left"></i> flask中current_app、g、request、session源码的深究和理解
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2019/01/14/应用服务器与WSGI协议以及flask后端框架总结-后端接收请求返回响应的整个流程/" rel="prev" title="应用服务器与WSGI协议以及flask后端框架总结(后端接收请求返回响应的整个流程)">
                应用服务器与WSGI协议以及flask后端框架总结(后端接收请求返回响应的整个流程) <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>


  </div>


          </div>
          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope="" itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">顾金鑫</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          
            <nav class="site-state motion-element">
              
                <div class="site-state-item site-state-posts">
                
                  <a href="/archives/">
                
                    <span class="site-state-item-count">35</span>
                    <span class="site-state-item-name">日志</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-categories">
                  <a href="/categories/index.html">
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">6</span>
                    <span class="site-state-item-name">分类</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-tags">
                  <a href="/tags/index.html">
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">13</span>
                    <span class="site-state-item-name">标签</span>
                  </a>
                </div>
              
            </nav>
          

          

          

          

          
          

          
            
          
          

        </div>
      </div>

      
      <!--noindex-->
        <div class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
            
            
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#flask开启多线程"><span class="nav-number">1.</span> <span class="nav-text">flask开启多线程</span></a></li></ol></div>
            

          </div>
        </div>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2019</span>
  <span class="with-love" id="animate">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">EasyThink By jx</span>

  
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-area-chart"></i>
    </span>
    
    <span title="站点总字数">113k</span>
  

  
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    
    <span title="站点阅读时长">1:42</span>
  
</div>









        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>

  
    <span class="post-meta-item-icon">
      <i class="fa fa-user"></i>
    </span>
    <span class="site-uv" title="总访客量">
      <span class="busuanzi-value" id="busuanzi_value_site_uv"></span>
    </span>
  

  
    <span class="post-meta-divider">|</span>
  

  
    <span class="post-meta-item-icon">
      <i class="fa fa-eye"></i>
    </span>
    <span class="site-pv" title="总访问量">
      <span class="busuanzi-value" id="busuanzi_value_site_pv"></span>
    </span>
  
</div>









        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

    

    
  </div>

  

<script>
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>














  
    
    
  
  <script color="0,0,255" opacity="0.5" zindex="-1" count="99" src="/lib/canvas-nest/canvas-nest.min.js"></script>













  
  <script src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>


  


  <script src="/js/src/utils.js?v=6.7.0"></script>

  <script src="/js/src/motion.js?v=6.7.0"></script>



  
  


  <script src="/js/src/affix.js?v=6.7.0"></script>

  <script src="/js/src/schemes/pisces.js?v=6.7.0"></script>




  
  <script src="/js/src/scrollspy.js?v=6.7.0"></script>
<script src="/js/src/post-details.js?v=6.7.0"></script>



  


  <script src="/js/src/bootstrap.js?v=6.7.0"></script>



  
  





  





  

  

  

  

  

  

  

  

  

  

  

  

  

</body>
</html>
